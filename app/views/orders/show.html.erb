<div class="space-y-6">
  <!-- Breadcrumb -->
  <nav class="flex" aria-label="Breadcrumb">
    <ol class="flex items-center space-x-2">
      <li>
        <%= link_to "Orders", orders_path, class: "text-gray-500 hover:text-gray-700" %>
      </li>
      <li>
        <span class="text-gray-400">/</span>
      </li>
      <li class="text-gray-900 font-medium">
        Order #<%= @order.id %>
      </li>
    </ol>
  </nav>

  <!-- Header -->
  <div class="border-b border-gray-200 pb-5">
    <div class="flex justify-between items-start">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Order #<%= @order.id %></h1>
        <p class="mt-2 text-sm text-gray-500">
          Placed <%= time_ago_in_words(@order.created_at) %> ago
        </p>
      </div>
      
      <div class="flex gap-2">
        <% if @order.can_modify? %>
          <%= link_to "Modify", edit_order_path(@order), class: "inline-flex items-center rounded-md bg-gray-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-500" %>
        <% end %>
        
        <% if @order.can_cancel? %>
          <%= button_to "Cancel Order", cancel_order_path(@order), method: :post, class: "inline-flex items-center rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500", form: { data: { turbo_confirm: "Are you sure you want to cancel this order?" } } %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main content - Order details -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Order information card -->
      <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Order Information</h2>
        </div>
        
        <div class="px-6 py-4">
          <dl class="grid grid-cols-2 gap-4">
            <div>
              <dt class="text-sm font-medium text-gray-500">Security</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= @order.security.ticker %> - <%= @order.security.name %>
              </dd>
            </div>
            
            <div>
              <dt class="text-sm font-medium text-gray-500">Status</dt>
              <dd class="mt-1">
                <%
                  status_colors = {
                    "pending" => "bg-yellow-100 text-yellow-800",
                    "open" => "bg-blue-100 text-blue-800",
                    "partially_filled" => "bg-indigo-100 text-indigo-800",
                    "filled" => "bg-green-100 text-green-800",
                    "cancelled" => "bg-gray-100 text-gray-800",
                    "rejected" => "bg-red-100 text-red-800",
                    "expired" => "bg-orange-100 text-orange-800"
                  }
                %>
                <span class="inline-flex rounded-full px-2 py-1 text-xs font-semibold <%= status_colors[@order.status] %>">
                  <%= @order.status.titleize %>
                </span>
              </dd>
            </div>
            
            <div>
              <dt class="text-sm font-medium text-gray-500">Side</dt>
              <dd class="mt-1">
                <span class="inline-flex rounded-full px-2 py-1 text-xs font-semibold <%= @order.buy? ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                  <%= @order.side.titleize %>
                </span>
              </dd>
            </div>
            
            <div>
              <dt class="text-sm font-medium text-gray-500">Order Type</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= @order.order_type.titleize %>
              </dd>
            </div>
            
            <div>
              <dt class="text-sm font-medium text-gray-500">Quantity</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= number_with_delimiter(@order.quantity) %> shares
              </dd>
            </div>
            
            <div>
              <dt class="text-sm font-medium text-gray-500">Price</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= @order.price ? number_to_currency(@order.price, unit: "KES ") : "Market Price" %>
              </dd>
            </div>
            
            <% if @order.stop_price %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Stop Price</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <%= number_to_currency(@order.stop_price, unit: "KES ") %>
                </dd>
              </div>
            <% end %>
            
            <div>
              <dt class="text-sm font-medium text-gray-500">Time in Force</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= @order.time_in_force.upcase %>
              </dd>
            </div>
            
            <div>
              <dt class="text-sm font-medium text-gray-500">Filled Quantity</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= number_with_delimiter(@order.filled_quantity || 0) %> shares
                <span class="text-gray-500">(<%= @order.fill_percentage %>%)</span>
              </dd>
            </div>
            
            <div>
              <dt class="text-sm font-medium text-gray-500">Remaining</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= number_with_delimiter(@order.remaining_quantity) %> shares
              </dd>
            </div>
            
            <% if @order.average_fill_price %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Average Fill Price</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <%= number_to_currency(@order.average_fill_price, unit: "KES ") %>
                </dd>
              </div>
            <% end %>
            
            <div>
              <dt class="text-sm font-medium text-gray-500">Created At</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= @order.created_at.strftime("%Y-%m-%d %H:%M:%S") %>
              </dd>
            </div>
            
            <% if @order.executed_at %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Executed At</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <%= @order.executed_at.strftime("%Y-%m-%d %H:%M:%S") %>
                </dd>
              </div>
            <% end %>
            
            <% if @order.cancelled_at %>
              <div>
                <dt class="text-sm font-medium text-gray-500">Cancelled At</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <%= @order.cancelled_at.strftime("%Y-%m-%d %H:%M:%S") %>
                </dd>
              </div>
            <% end %>
          </dl>
        </div>
      </div>

      <!-- Execution history -->
      <% if @order.filled_quantity && @order.filled_quantity > 0 %>
        <div class="bg-white shadow rounded-lg overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Execution History</h2>
          </div>
          
          <div class="px-6 py-4">
            <p class="text-sm text-gray-500">
              This order has been <%= @order.fill_percentage %>% filled
            </p>
            
            <% if @order.filled? %>
              <div class="mt-4 p-4 bg-green-50 rounded-md">
                <p class="text-sm text-green-800">
                  <strong>Order fully executed</strong><br>
                  <%= number_with_delimiter(@order.filled_quantity) %> shares at average price of <%= number_to_currency(@order.average_fill_price, unit: "KES ") %>
                </p>
              </div>
            <% elsif @order.partially_filled? %>
              <div class="mt-4 p-4 bg-blue-50 rounded-md">
                <p class="text-sm text-blue-800">
                  <strong>Partial fill</strong><br>
                  <%= number_with_delimiter(@order.filled_quantity) %> of <%= number_with_delimiter(@order.quantity) %> shares filled<br>
                  <%= number_with_delimiter(@order.remaining_quantity) %> shares remaining
                </p>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Current market data -->
      <div class="bg-white shadow rounded-lg overflow-hidden" data-controller="market-data" data-market-data-ticker-value="<%= @order.security.ticker %>">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Current Market</h2>
        </div>
        
        <div class="px-6 py-4 space-y-3">
          <% latest_quote = @order.security.latest_quote %>
          <% if latest_quote %>
            <div>
              <dt class="text-sm font-medium text-gray-500">Last Price</dt>
              <dd class="mt-1 text-2xl font-bold text-gray-900" data-market-data-target="lastPrice">
                <%= number_to_currency(latest_quote.last_price, unit: "KES ") %>
              </dd>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
              <div>
                <dt class="text-sm font-medium text-gray-500">Bid</dt>
                <dd class="mt-1 text-lg font-semibold text-green-600" data-market-data-target="bid">
                  <%= number_to_currency(latest_quote.bid, unit: "KES ") %>
                </dd>
              </div>
              
              <div>
                <dt class="text-sm font-medium text-gray-500">Ask</dt>
                <dd class="mt-1 text-lg font-semibold text-red-600" data-market-data-target="ask">
                  <%= number_to_currency(latest_quote.ask, unit: "KES ") %>
                </dd>
              </div>
            </div>
            
            <div>
              <dt class="text-sm font-medium text-gray-500">Volume</dt>
              <dd class="mt-1 text-sm text-gray-900" data-market-data-target="volume">
                <%= number_with_delimiter(latest_quote.volume) %>
              </dd>
            </div>
            
            <div class="text-xs text-gray-400">
              Updated <%= time_ago_in_words(latest_quote.timestamp) %> ago
            </div>
          <% else %>
            <p class="text-sm text-gray-500">No market data available</p>
          <% end %>
        </div>
      </div>

      <!-- Order actions -->
      <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Actions</h2>
        </div>
        
        <div class="px-6 py-4 space-y-2">
          <%= link_to "View #{@order.security.ticker}", security_path(@order.security), class: "block w-full text-center rounded-md bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-900 hover:bg-gray-200" %>
          
          <% if current_user.can_trade? %>
            <%= link_to "Place Similar Order", new_order_path(security_id: @order.security_id, side: @order.side), class: "block w-full text-center rounded-md bg-blue-100 px-4 py-2 text-sm font-semibold text-blue-900 hover:bg-blue-200" %>
          <% end %>
          
          <%= link_to "Back to Orders", orders_path, class: "block w-full text-center rounded-md bg-gray-100 px-4 py-2 text-sm font-semibold text-gray-900 hover:bg-gray-200" %>
        </div>
      </div>
    </div>
  </div>
</div>
